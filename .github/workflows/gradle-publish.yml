name: Release Mod

on:
  push:
    branches: [ main ]
    paths: [ 'CHANGELOG.md' ]

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4

    - name: Parse version from CHANGELOG.md
      id: parse_version
      run: |
        version=$(grep -m1 '^## \[' CHANGELOG.md | sed 's/^## \[\(.*\)\].*/\1/')
        echo "version=$version" >> $GITHUB_OUTPUT
        echo "Parsed version: $version"

    - name: Update gradle.properties with new version
      run: |
        sed -i "s/mod_version=.*/mod_version=${{ steps.parse_version.outputs.version }}/" gradle.properties
        cat gradle.properties | grep mod_version

    - name: Commit version update
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add gradle.properties
        git commit -m "Update version to ${{ steps.parse_version.outputs.version }}" || echo "No changes to commit"
        git push

    - name: Build JAR
      run: ./gradlew build

    - name: Read changelog
      id: changelog
      run: |
        body=$(cat CHANGELOG.md)
        body="${body//'%'/'%25'}"
        body="${body//$'\n'/'%0A'}"
        body="${body//$'\r'/'%0D'}"
        echo "body=$body" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.parse_version.outputs.version }}
        name: ${{ steps.parse_version.outputs.version }}
        body: ${{ steps.changelog.outputs.body }}
        files: build/libs/*.jar
        draft: false
        prerelease: ${{ contains(steps.parse_version.outputs.version, '-') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
